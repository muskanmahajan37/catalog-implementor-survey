## Overview 
 
Pixia Catalog is a database system designed to store metadata for spatiotemporal 
assets, i.e. anything with geometry and time. It does not store assets themselves, nor does it 
understand the data formats or sensor type used by the assets. 

It provides various REST calls to search the database. OGCÂ® ECQL is used
as the query language. As required by ECQL, geometries are represented as WKT in 
queries.

Regardless of the backend database used to store data, the API always exposes the
data in JSON. Geometries are represented as GeoJSON geometry objects. Besides the
proprietary JSON format, it can also return results as GeoJSON FeatureCollection.

## Terminology

#### Provider

The provider of the assets. The metadata from the same provider must share the
same schema and all fields should have the same semantics.

The data is partitioned by provider. `provider` is a required parameter in 
all search operations.

#### Asset

Asset is the basic data unit stored in the system. Anything with geometry
and time can be an asset. 

The required fields for assets are:

* `provider` The provider of the asset
* `name` An unique name for the asset
* `geometry` GeoJSON representing footprint of the geometry
* `period` Time period of the asset    
* `url` The location of the data for the asset

#### Group

Groups are used to organize assets, like folders in filesystem. A group
can have a parent group to form a tree.

Group is not required. A default group `unfiled` is used if none is provided.

The required fields for groups are:

* `provider` The provider of the data
* `name` A unique name for the group

A group's `geometry` is a calculated footprint of the all assets under this group.
The `period` is the super range that covers the periods of all its assets.

#### Item

Items are fabricated entities that are used to support LOD (Level of Details) for a
thematic map or timeline. An item can represent either an asset or a group. When 
it's too expensive to display assets, the system returns groups instead. A system 
may also generate vGroups (Virtual Group) if there are too many physical groups 
to display.

## Data Format

#### Data Types

The data is represented as JSON throughout the API. The system is capable of
storing any kind of data. However, data type must be specified for indexed fields 
so the proper index scheme can be selected by the backend database systems.

The following types are supported:

* `String` A text string
* `Text` A text string with text-search index
* `Integer` 32-bit integer
* `Long` 64-bit integer
* `Float` IEEE double-precision floating-point number
* `Time` A timestamp with millisecond precision
* `StringSet` A set made of text entities
* `IntegerSet` A set made of integers
* `TimeRange` A time range with `begin` and `end`
* `IntegerRange` A integer range with `begin` and `end`
* `FloatRange` A floating-point range with `begin` and `end`
* `Doc` Document storage, implemented as CLOB or JSON depending on database
* `Geo` Geospatial field

#### Schema

The data model is document-based and arbitrary data can be stored and returned. 
However, some basic schema must be followed for assets and groups.

The following fields are common to both assets and groups:

* `id` The ID of the record, a 20-char string generated by the system
* `provider` Provider ID. Provider must be provisioned before an asset/group 
can be registered
* `name` The name of the asset/group, must be unique
* `geometry` GeoJSON representing the footprint of the asset/group. Only point 
and polygon are supported, including MultiPolygon. Not required for group
* `period` Time range for the asset/group. Not required for group
* `sourceGeometry` The geometry is simplified to speed up the index. This field
holds the original geometry
* `source` Un-normalized original metadata

These fields are for assets only:

* `groupName` The name of the group, optional
* `url` URL for the content of the asset, required
* `subject` Searchable text describing the asset, optional
* `keywords` Text-search fields, optional

These fields are for groups only:

* `parent` Parent group ID, `null` if no parent
* `groupType` Indicates whether this is a physical or virtual group
* `sourcePeriod` The `period` in a group is calculated based on the periods of
all child assets. This field holds the original period value for a group if any
is provided in group registration
* `assetCount` Number of assets under this group


## REST API

The full API is documented in the OpenAPI (Swagger) specification. 

The REST calls can be divided into following categories:

1. Basic CRUD operations: `/group`, `/asset`
2. Search operations: `/groups`, `/assets`, `/feature/groups`, `feature/assets`
3. Auxiliary operations for UI : `/items`, `/timeline`
4. Administrative operations: `/providers`

#### Error Response

All REST calls share the same error response format. Only 2 HTTP Status Codes 
are used for errors.

* `400`: Invalid request. e.g. Missing required fields, values out of range, etc...
* `500`: Server error. e.g. Database error, timeout, etc... Client should retry.

The format of the `ErrorResponse`

    {
        "code" : "A error code (text)",
        "message" : "A localized text message",
        "fields" : "an optional object to return errors for each field"
    }
   
`exception` and `stackTrace` may also be returned in debug mode.
   

#### Registration

##### Asset Registration/Update

    Endpoint: /api/asset
    Method: Post

The `POST` is used for both CREATE and UPDATE operation. When ID is provided, it's
an update. Otherwise, it's a CREATE.

The body of the request contains the JSON for the asset. For example,

    {
      "provider" : "pixia",
      "name" : "test-dg-4",
      "url" : "file:///mnt/wdc-cluster-01/srcimg/test4.TIF",
      "group" : "test",
      "period" : {
        "begin" : 1345969788782,
        "end" : 1345969788782
      },
      "types" : [ "orthoRaster" ],
      "geometry" : {
        "type" : "Polygon",
        "coordinates" : [ [ [ 35.95399425000001, 33.94233675 ], [ 35.953998750000004, 33.94233675 ], [ 35.95400325000001, 33.94233675 ], [ 35.95400775, 33.94233675 ], [ 35.954012250000005, 33.94233675 ], [ 35.95446675000001, 33.942327750000004 ], [ 35.954471250000005, 33.942327750000004 ], [ 35.95447575, 33.942327750000004 ], [ 35.95448025000001, 33.942327750000004 ], [ 35.954484750000006, 33.94232325000001 ], [ 35.95448925000001, 33.94232325000001 ], [ 36.02736225, 33.94043016468969 ], [ 36.02736225, 33.86865375 ], [ 35.9546980003687, 33.86865375 ], [ 35.95399425000001, 33.94233225000001 ], [ 35.95399425000001, 33.94233675 ] ] ],
        "crs" : {
          "type" : "name",
          "properties" : {
            "name" : "EPSG:4326"
          }
        },
        "bbox" : [ 35.95399425000001, 33.86865375, 36.02736225, 33.94233675 ]
      },
      "sensorAzimuthDeg" : {
        "begin" : 154.5,
        "end" : 154.5
      },
      "offNadirAngle" : {
        "begin" : 13.0,
        "end" : 13.0
      },
      "sensorElevationDeg" : {
        "begin" : 75.8,
        "end" : 75.8
      },
      "sunAzimuthDeg" : {
        "begin" : 142.4,
        "end" : 142.4
      },
      "cloudCover" : {
        "begin" : 0.0,
        "end" : 0.0
      },
      "predictedNiirs" : {
        "begin" : 4.9,
        "end" : 4.9
      },
      "sunElevationDeg" : {
        "begin" : 62.0,
        "end" : 62.0
      }
    }


##### Group Registration/Update

    Endpoint: /api/group
    Method: POST

Group registration works very similarly to asset registration except one difference -
the operation is an "Upsert". If the group exists, it's an UPDATE. 
Otherwise it's a CREATE. 
 
#### Retrieval

##### Asset Retrieval

    Endpoint: /api/asset
    Method: GET
    
Asset can be retrieved by ID or name. If ID is provided, name is ignored.

For example,

    http://api.pixia.com/catalog/api/asset?id=abgxyrfeg0s2eu4dmftv
    
The response is the JSON document for the asset,
 
     {
       "id" : "abgxyrfeg0s2eu4dmftv",
       "provider" : "pixia",
       "name" : "test-dg-4",
       "url" : "file:///mnt/wdc-cluster-01/srcimg/test4.TIF",
       "groupId" : "gbgxyrfeg0s389r2cupu",
       "period" : {
         "begin" : 1345969788782,
         "end" : 1345969788782
       },
       "types" : [ "orthoRaster" ],
       "geometry" : {
         "type" : "Polygon",
         "coordinates" : [ [ [ 35.95399425000001, 33.94233675 ], [ 35.953998750000004, 33.94233675 ], [ 35.95400325000001, 33.94233675 ], [ 35.95400775, 33.94233675 ], [ 35.954012250000005, 33.94233675 ], [ 35.95446675000001, 33.942327750000004 ], [ 35.954471250000005, 33.942327750000004 ], [ 35.95447575, 33.942327750000004 ], [ 35.95448025000001, 33.942327750000004 ], [ 35.954484750000006, 33.94232325000001 ], [ 35.95448925000001, 33.94232325000001 ], [ 36.02736225, 33.94043016468969 ], [ 36.02736225, 33.86865375 ], [ 35.9546980003687, 33.86865375 ], [ 35.95399425000001, 33.94233225000001 ], [ 35.95399425000001, 33.94233675 ] ] ],
         "crs" : {
           "type" : "name",
           "properties" : {
             "name" : "EPSG:4326"
           }
         },
         "bbox" : [ 35.95399425000001, 33.86865375, 36.02736225, 33.94233675 ]
       },
       "sensorAzimuthDeg" : {
         "begin" : 154.5,
         "end" : 154.5
       },
       "offNadirAngle" : {
         "begin" : 13.0,
         "end" : 13.0
       },
       "sensorElevationDeg" : {
         "begin" : 75.8,
         "end" : 75.8
       },
       "sunAzimuthDeg" : {
         "begin" : 142.4,
         "end" : 142.4
       },
       "cloudCover" : {
         "begin" : 0.0,
         "end" : 0.0
       },
       "predictedNiirs" : {
         "begin" : 4.9,
         "end" : 4.9
       },
       "sunElevationDeg" : {
         "begin" : 62.0,
         "end" : 62.0
       }
     }

##### Group Retrieval

    Endpoint: /api/group
    Method: GET
    
Group retrieval works exactly the same as asset retrieval.

#### Search

All the search calls share the same parameters:

* `provider` Provider ID
* `query` Query in ECQL. One extension to standard ECQL is that dot notation
 can be used for object member reference. For example, 
 `"sensorAzimuthDeg.begin < 120.0"`
* `bbox` A shorthand for bounding box intersects query in the form of
`w-lon,s-lat,e-lon,n-lat`. The box follows west-east winding. One benefit
over ECQL is that `bbox` can support any area, even the whole globe 
(e.g. `"0,-90,0,90"`). The box is split into many small ones if backend 
database can't handle it
* `time` A shorthand for time period intersects query in the form of 
`begin,end` or `time`. Time value must be milliseconds since epoch
* `fields` Fields to return for asset/group
* `start` Start record number for pagination
* `limit` Maximum number of records to return per page

All the responses share the same format `PageableResults`,

    {
        "count" : "Number of results returned",
        "start" : "Start number of the results for pagination",
        "total" : "Total number of results",
        "results" : [
            {"results1"},
            {"results2"}
        ]
    }
 
##### Asset Search
 
    Endpoint: /api/assets
    Method: GET
    
Here is an example request. All the parameters must be properly URL-encoded.

    http://api.pixia.com/catalog/api/assets?provider=pixia&bbox=-13.447265625,-17.05078125,33.3984375,34.892578125&query=(sunAzimuthDeg.begin+%3E%3D+0+AND+sunAzimuthDeg.end+%3C%3D+90)+AND+(sunElevationDeg.begin+%3E%3D+-90+AND+sunElevationDeg.end+%3C%3D+-1)

Here is abbreviated response,

    {
      "start": 0,
      "count": 26,
      "total": 26,
      "results": [
        {
          "id": "abeqe1kpa2wgpmqxhz1a",
          "name": "20170402_133906_1_0c46-0",
          "types": [
            "orthoRaster"
          ]
        },
        
        ...
        
      ]
    }
    

##### Asset Search (GeoJSON)

    Endpoint: /api/feature/assets
    Method: GET
    
This call is exactly the same as `/api/assets`, except that the response is
a GeoJSON FeatureCollection.

Here is a sample response. The geometry is always returned in GeoJSON.

    {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  43.423685804275,
                  37.802183854217
                ],
                [
                  43.617120673194,
                  37.804613801164
                ],
                [
                  43.620240923594,
                  37.636609248478
                ],
                [
                  43.427242098037,
                  37.634193887657
                ],
                [
                  43.423685804275,
                  37.802183854217
                ]
              ]
            ],
            "crs": {
              "type": "name",
              "properties": {
                "name": "EPSG:4326"
              }
            },
            "bbox": [
              43.423685804275,
              37.634193887657,
              43.620240923594,
              37.804613801164
            ]
          },
          "properties": {
            "id": "abeqe1kpa2wgpmqxhz1a",
            "name": "20170402_133906_1_0c46-0",
            "itemType": "asset",
            "geometryType": "blob",
            "period": {
              "begin": 1491140346000,
              "end": 1491140346000
            },
            "types": [
              "orthoRaster"
            ]
          }
        },
     
        ...
      ],
      "properties": {
        "start": 0,
        "count": 26,
        "total": 26
      }
    }
    
##### Group Search

    Endpoint: /api/groups
    Method: GET
    
This call works exactly the same as `/api/assets`, except that it searches the
group database.

##### Group Search (GeoJSON)

    Endpoint: /api/feature/groups
    Method: GET
    
This call works exactly the same as `/api/feature/assets`, except that it searches the
group database.

##### Item Search

    Endpoint: /api/items
    Method: GET
     
The item search returns either assets or groups depending on the level of details
required for the query parameters.

Unlike asset/group search, this call can return either `PageableResults` or 
FeatureCollection based on following parameter,

* `format` `json` to return PageableResults. `geojson` to return FeatureCollection.

##### Timeline Search

    Endpint: /api/timeline
    Method: GET
    
Timeline search is used to return data used to build a timeline. The query parameters
are exactly the same as other queries.

The response is an array of objects with date and count.

* `date` The date in the form of `YYYY-MM-DD`
* `count` The number of assets whose periods cover this date

Here is an abbreviated response,

    [
      {
        "date": "2017-02-19",
        "count": 69
      },
      {
        "date": "2017-04-04",
        "count": 1856
      }
    ]